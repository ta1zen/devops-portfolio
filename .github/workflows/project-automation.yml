name: Project Automation

on:
  pull_request:
    types: [opened, closed]

jobs:
  update-project:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      #projects: write

    steps:
      - name: Authenticate GitHub CLI
        run: echo "${{ github.token }}" | gh auth login --with-token

      - name: Add PR to project if not exists & move to Review
        if: github.event.action == 'opened'
        run: |
          # Add PR to project
          ITEM_ID=$(gh project item-add 4 --owner "@me" --url ${{ github.event.pull_request.html_url }} --json id -q ".id")
          echo "PR added with item ID $ITEM_ID"

          # Move to Review
          gh api graphql -f query="
            mutation {
              updateProjectV2ItemFieldValue(
                input: {
                  projectId: \"PVT_kwHOCYwIqs4BCszZ\"
                  itemId: \"$ITEM_ID\"
                  fieldId: \"PVTSSF_lAHOCYwIqs4BCszZzg01Zuk\"
                  value: { singleSelectOptionId: \"9526636c\" }
                }
              ) {
                projectV2Item { id }
              }
            }"

      # - name: Move PR to Done when merged
      #   if: github.event.action == 'closed' && github.event.pull_request.merged == true
      #   run: |
      #     # Move PR card to Done
      #     ITEM_ID=$(gh project item-list 4 --json id,content --jq ".[] | select(.content.id==\"${{ github.event.pull_request.node_id }}\") | .id")
      #     gh api graphql -f query="
      #       mutation {
      #         updateProjectV2ItemFieldValue(
      #           input: {
      #             projectId: \"PVT_kwHOCYwIqs4BCszZ\"
      #             itemId: \"$ITEM_ID\"
      #             fieldId: \"PVTSSF_lAHOCYwIqs4BCszZzg01Zuk\"
      #             value: { singleSelectOptionId: \"98236657\" }
      #           }
      #         ) {
      #           projectV2Item { id }
      #         }
      #       }"
