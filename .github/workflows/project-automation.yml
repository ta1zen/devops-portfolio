name: Project Automation

on:
  pull_request:
    types: [opened, closed]

jobs:
  update-project:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      projects: write

    steps:
      - name: Authenticate GitHub CLI
        run: echo "${{ github.token }}" | gh auth login --with-token

      - name: Move PR to "Review" when opened
        if: github.event.action == 'opened'
        run: |
          gh api graphql -f query='
            mutation {
              updateProjectV2ItemFieldValue(
                input: {
                  projectId: "PVT_kwHOCYwIqs4BCszZ"
                  itemId: "${{ github.event.pull_request.node_id }}"
                  fieldId: "PVTSSF_lAHOCYwIqs4BCszZzg01Zuk"
                  value: { singleSelectOptionId: "9526636c" }
                }
              ) {
                projectV2Item { id }
              }
            }'

      - name: Move PR to "Done" when merged
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        run: |
          gh api graphql -f query='
            mutation {
              updateProjectV2ItemFieldValue(
                input: {
                  projectId: "PVT_kwHOCYwIqs4BCszZ"
                  itemId: "${{ github.event.pull_request.node_id }}"
                  fieldId: "PVTSSF_lAHOCYwIqs4BCszZzg01Zuk"
                  value: { singleSelectOptionId: "98236657" }
                }
              ) {
                projectV2Item { id }
              }
            }'
