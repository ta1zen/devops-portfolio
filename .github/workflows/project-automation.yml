name: Project Automation

on:
  pull_request:
    types: [opened, closed]

jobs:
  update-project:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      pull-requests: write
      issues: write
      # projects: write не потрібен, бо використовується GH_PAT

    steps:
      - name: Checkout
        uses: actions/checkout@v4  # Для доступу до репозиторію

      - name: Authenticate GitHub CLI with Classic PAT
        run: echo "${{ secrets.GH_PAT }}" | gh auth login --with-token

      - name: Check auth status and project access
        run: |
          gh auth status  # Перевіряємо scopes токена
          echo "Authenticated as: $(gh api user --jq .login)"
          # Перевірка версії gh CLI
          gh --version
          # Перевірка доступу до проєкту 4
          gh api graphql -f query='
            query {
              viewer {
                projectV2(number: 4) {
                  id
                  title
                }
              }
            }' --jq '.data.viewer.projectV2 | {id: .id, title: .title}'
          # Список проєктів для перевірки
          gh project list --owner "@me" --limit 10

      - name: Add PR to project if not exists & move to Review
        if: github.event.action == 'opened'
        run: |
          # Add PR to project
          ITEM_ID=$(gh project item-add 4 --owner "@me" --url ${{ github.event.pull_request.html_url }} --format json -q ".id")
          echo "PR added with item ID $ITEM_ID"

          if [ -z "$ITEM_ID" ]; then
            echo "Error: Failed to add PR to project"
            exit 1
          fi

          # Move to Review
          RESPONSE=$(gh api graphql -f query="
            mutation {
              updateProjectV2ItemFieldValue(
                input: {
                  projectId: \"PVT_kwHOCYwIqs4BCszZ\"
                  itemId: \"$ITEM_ID\"
                  fieldId: \"PVTSSF_lAHOCYwIqs4BCszZzg01Zuk\"
                  value: { singleSelectOptionId: \"9526636c\" }
                }
              ) {
                projectV2Item { id }
              }
            }" --jq '.data.updateProjectV2ItemFieldValue.projectV2Item.id')
          echo "Updated item ID: $RESPONSE"
          
      - name: Move PR to Done if merged
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        run: |
          # Find the item ID for the PR in the project
          ITEM_ID=$(gh api graphql -f query='
            query {
              node(id: "PVT_kwHOCYwIqs4BCszZ") {
                ... on ProjectV2 {
                  items(first: 100, filter: {content: {url: "${{ github.event.pull_request.html_url }}"}}) {
                    nodes {
                      id
                    }
                  }
                }
              }
            }' --jq '.data.node.items.nodes[0].id')
          
          if [ -z "$ITEM_ID" ]; then
            echo "Error: PR not found in project"
            exit 1
          fi
          echo "Found item ID: $ITEM_ID"
      
          # Move to Done
          RESPONSE=$(gh api graphql -f query="
            mutation {
              updateProjectV2ItemFieldValue(
                input: {
                  projectId: \"PVT_kwHOCYwIqs4BCszZ\"
                  itemId: \"$ITEM_ID\"
                  fieldId: \"PVTSSF_lAHOCYwIqs4BCszZzg01Zuk\"
                  value: { singleSelectOptionId: \"98236657\" }
                }
              ) {
                projectV2Item { id }
              }
            }" --jq '.data.updateProjectV2ItemFieldValue.projectV2Item.id')
          echo "Moved to Done, updated item ID: $RESPONSE"
